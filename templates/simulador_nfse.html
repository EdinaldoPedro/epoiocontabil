<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Compor Valor Bruto na NFS-e</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
  <script src="https://unpkg.com/lucide@latest"></script>
  
  </head>
<body>
  <header><h1><i data-lucide="file-input"></i> Como Compor o Valor Bruto na NFS-e</h1></header>

<main>
  <div class="wrap">
    <h2>Compor Valor Bruto da NFS-e</h2>

        <div class="grid-2-cols">
          <div class="card">
            <label class="label">
              Valor Líquido desejado (R$)
              <span class="info-tooltip" data-text="O valor exato que você quer receber na sua conta bancária após descontar todos os impostos.">
                <i data-lucide="circle-help" width="15" height="15"></i>
              </span>
            </label>
            <div class="currency-wrapper">
              <input id="valor_liquido" type="text" class="currency-input currency" placeholder="R$ 0,00">
            </div>
            <div id="erro_liquido" class="error-msg" style="display:none;">Preencha este campo</div>
          </div>

          <div class="card">
            <label class="label">
              Alíquota atual do seu Imposto Total (%)
              <span class="info-tooltip" data-text="A porcentagem total de imposto que incide sobre sua nota (ex: sua alíquota efetiva do Simples Nacional ou 16.33% do Lucro Presumido).">
                <i data-lucide="circle-help" width="15" height="15"></i>
              </span>
            </label>
            <div class="percent-wrapper">
              <input id="imposto_principal" type="number" step="0.01" placeholder="0,00">
            </div>
            <div id="erro_imposto" class="error-msg" style="display:none;">Preencha este campo</div>
          </div>
        </div>
        
        <div class="card">
          <label class="label">
            Custos adicionais
            <span class="info-tooltip" data-text="Adicione despesas extras que devem ser cobradas do cliente e embutidas na nota (ex: taxa de boleto, deslocamento, licenças de software).">
              <i data-lucide="circle-help" width="15" height="15"></i>
            </span>
          </label>
          <div id="custos_area"></div>
          <button onclick="adicionarCusto()">Adicionar custo</button>
        </div>

    <div class="action-right">
      <button onclick="calcular()">Calcular Valor Bruto</button>
    </div>

    <div id="resultado" class="card" style="margin-top:20px; display:none;"></div>
  </div>
</main>

<script>
// ====================================================================
// FUNÇÕES DE MÁSCARA E LÓGICA
// ====================================================================

function parseToNumber(s) {
    if (s === null || s === undefined) return null;
    let t = String(s).trim();
    if (!t) return null;
    t = t.replace(/\s/g, '').replace(/R\$/gi, '');
    const comma = t.indexOf(',');
    const dot = t.indexOf('.');
    
    if (dot !== -1 && comma !== -1) t = t.replace(/\./g, '').replace(',', '.');
    else if (comma !== -1 && dot === -1) t = t.replace(',', '.');
    t = t.replace(/[^0-9\.\-]/g, '');
    const n = Number(t);
    return isNaN(n) ? null : n;
}

function attachCurrencyBehaviorSmart(inp) {
    inp.addEventListener('input', () => {
        let val = inp.value.replace(/[^\d]/g, ''); 
        if (val === '') { inp.dataset.value = ''; inp.value = ''; return; }
        let num = parseFloat(val) / 100; 
        inp.dataset.value = num;
        inp.value = num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    });
    
    inp.addEventListener('focus', () => {
        if (!inp.dataset.value) inp.value = ''; 
    });
    inp.addEventListener('paste', (ev) => {
        ev.preventDefault();
        const text = (ev.clipboardData || window.clipboardData).getData('text');
        const num = parseToNumber(text);
        if (num !== null) {
            inp.dataset.value = num;
            inp.value = num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
    });
    
    inp.getNumericValue = () => inp.dataset.value ? parseFloat(inp.dataset.value) : null;
    inp.setNumericValue = (num) => {
        inp.dataset.value = num;
        inp.value = num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };
}
// ====================================================================


let custos = [];

function marcarErro(campo, msg) {
    campo.classList.add("campo-erro");
    msg.style.display = "block";
}
function limparErro(campo, msg) {
    campo.classList.remove("campo-erro");
    msg.style.display = "none";
}

/* --- Adicionar blocos de custos --- */
function adicionarCusto() {
  const id = Date.now();

  const custoHtml = `
      <div class="card custo-item" id="custo_card_${id}">
          <div class="grid-3-cols">
              <input id="desc_${id}" placeholder="Descrição do Custo" style="grid-column: 1 / span 3; box-sizing: border-box;">

              <select id="tipo_${id}" onchange="toggleValorInput('${id}')" style="grid-column: 1 / 2;">
                  <option value="">-- Tipo --</option>
                  <option value="%">Percentual (%)</option>
                  <option value="R$">Valor Fixo (R$)</option>
              </select>
              
              <div id="wrapper_val_${id}" style="grid-column: 2 / span 2;"></div>
          </div>

          <button type="button" onclick="document.getElementById('custo_card_${id}').remove()" style="background: #e74c3c; box-shadow: none; font-size: 13px; padding: 6px 12px; margin-top: 8px;">Remover Custo</button>
      </div>
    `;
    document.getElementById("custos_area").insertAdjacentHTML('beforeend', custoHtml);
}

/* --- Mostra/oculta o campo de valor --- */
function toggleValorInput(id) {
    const tipoSelect = document.getElementById(`tipo_${id}`);
    const valorWrapper = document.getElementById(`wrapper_val_${id}`);
    const tipo = tipoSelect.value;

    if (tipo === "R$") {
        valorWrapper.innerHTML = `
            <div class="currency-wrapper">
                <input id="val_${id}" type="text" class="currency-input currency" placeholder="R$ 0,00">
            </div>
        `;
        valorWrapper.style.display = "block";
        
        attachCurrencyBehaviorSmart(document.getElementById(`val_${id}`)); 

    } else if (tipo === "%") {
        valorWrapper.innerHTML = `
            <div class="percent-wrapper">
                <input id="val_${id}" type="number" step="0.01" placeholder="0,00">
            </div>
        `;
        valorWrapper.style.display = "block";
    } else {
        valorWrapper.innerHTML = "";
        valorWrapper.style.display = "none";
    }
}

/* --- Função principal de cálculo --- */
async function calcular() {
  const liquidoInput = document.getElementById("valor_liquido");
  const impostoInput = document.getElementById("imposto_principal");

  const erroLiq = document.getElementById("erro_liquido");
  const erroImp = document.getElementById("erro_imposto");

  limparErro(liquidoInput, erroLiq);
  limparErro(impostoInput, erroImp);

  const valor_liquido = liquidoInput.getNumericValue();
  const imposto_principal = parseFloat(impostoInput.value);

  let erro = false;

  if (valor_liquido === null || valor_liquido <= 0) {
      marcarErro(liquidoInput, erroLiq);
      erro = true;
  }

  if (!imposto_principal) {
      marcarErro(impostoInput, erroImp);
      erro = true;
  }

  if (erro) return;

  // montar lista de custos
  const inputs = document.querySelectorAll("#custos_area .card");
  custos = [];

  Array.from(inputs).forEach(div => {
      const descInput = div.querySelector("input[id^='desc']");
      const tipoSelect = div.querySelector("select[id^='tipo']");
      const valInput = div.querySelector("input[id^='val']");

      if (descInput && tipoSelect) {
          const desc = descInput.value;
          const tipo = tipoSelect.value;
          
          if (valInput) { 
              let val;
              
              if (tipo === "R$") {
                  val = valInput.getNumericValue();
              } else {
                  val = parseFloat(valInput.value);
              }

              if (desc && val !== null && !isNaN(val)) {
                  if (tipo === "%" && val >= 100) {
                      val = 99.99; 
                  }
                  custos.push({ descricao: desc, valor: val, tipo });
              }
          }
      }
  });


  const payload = { valor_liquido, imposto_principal, custos };

  try {
      const resp = await fetch("/calcular_valor_bruto", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const dados = await resp.json();

      if (resp.status !== 200) {
          alert("Erro ao calcular: " + (dados.erro || "Erro desconhecido"));
          return;
      }
      
      const formatarBRL = (valor) => {
          return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      let html = `
        <h3 style="color:var(--accent);">Resultado Calculado</h3>
        <p style="font-size:1.1em;">O valor total da Nota Fiscal deve ser: <strong style="color:var(--accent); font-size:1.2em;">R$ ${formatarBRL(dados.valor_bruto)}</strong></p>
        <div style="background:#f4f5fb; padding:10px; border-radius:8px; margin-top:10px;">
            <p><strong>Valor Líquido (na sua conta):</strong> R$ ${formatarBRL(dados.liquido_final)}</p>
            <hr style="border:0; border-top:1px solid #ddd; margin:10px 0;">
            <strong>Detalhamento das Cobranças:</strong>
      `;

      dados.detalhes.forEach(d => {
        html += `<div style="margin-top:4px;">• ${d.descricao}: R$ ${formatarBRL(d.valor)}</div>`;
      });
      
      html += `</div>`;

      document.getElementById("resultado").style.display = "block";
      document.getElementById("resultado").innerHTML = html;
      
      // Renderiza ícones caso o HTML injetado tenha algum (opcional)
      lucide.createIcons();

  } catch (err) {
      alert("Erro de conexão: " + err.message);
  }
}

// Inicializa a máscara no campo estático ao carregar a página
document.addEventListener('DOMContentLoaded', () => {
    const liquidoInput = document.getElementById('valor_liquido');
    attachCurrencyBehaviorSmart(liquidoInput);
});
</script>

  <footer>
    <div class="footer-left">
      <span>Simulador NFS-e • v1.0 • Dev: <strong>Edinaldo P.S.</strong></span>
      
      <a href="https://www.linkedin.com/in/edinaldo-pedro" target="_blank" class="footer-link" title="Ir para LinkedIn">
        <i data-lucide="linkedin" width="18" height="18" class="linkedin-icon"></i>
      </a>
    </div>

    <div class="footer-right">
      <a href="https://forms.gle/4vTHeUu8pWAcXatq7" target="_blank" class="btn-report">
        <i data-lucide="message-square-warning" width="16" height="16"></i>
        Reportar Erro / Feedback
      </a>
    </div>
  </footer>

<script>lucide.createIcons();</script>
</body>
</html>